syntax = "proto3";

package kontekst;
option go_package = "github.com/erg0nix/kontekst/internal/grpc/pb;pb";

service AgentService {
  rpc Run(stream RunCommand) returns (stream RunEvent);
}

service DaemonService {
  rpc GetStatus(GetStatusRequest) returns (GetStatusResponse);
  rpc Shutdown(ShutdownRequest) returns (ShutdownResponse);
}

message GetStatusRequest {}
message GetStatusResponse {
  string bind = 1;
  string endpoint = 2;
  string model_dir = 4;
  bool endpoint_healthy = 6;
  int64 uptime_seconds = 9;
  string started_at_rfc3339 = 10;
  string data_dir = 11;
}

message ShutdownRequest {}
message ShutdownResponse { string message = 1; }

message RunCommand {
  oneof command {
    StartRunCommand start = 1;
    ApproveToolCommand approve_tool = 2;
    DenyToolCommand deny_tool = 3;
    CancelRunCommand cancel = 6;
  }
}

message StartRunCommand {
  string prompt = 1;
  string session_id = 2;
  string agent_name = 3;
  string working_dir = 4;
  SkillInvocation skill = 5;
}

message SkillInvocation {
  string name = 1;
  string arguments = 2;
}
message ApproveToolCommand { string call_id = 1; }
message DenyToolCommand { string call_id = 1; string reason = 2; }
message CancelRunCommand {}

message RunEvent {
  oneof event {
    RunStartedEvent started = 1;
    TokenDeltaEvent token = 2;
    ReasoningDeltaEvent reasoning = 3;
    TurnCompletedEvent turn_completed = 4;
    ToolsProposedEvent tools_proposed = 5;
    ToolExecutionStartedEvent tool_started = 6;
    ToolExecutionCompletedEvent tool_completed = 7;
    ToolExecutionFailedEvent tool_failed = 8;
    ToolsCompletedEvent tools_completed = 9;
    RunCompletedEvent completed = 10;
    RunCancelledEvent cancelled = 11;
    RunFailedEvent failed = 12;
  }
}

message RunStartedEvent {
  string run_id = 1;
  string session_id = 2;
  string agent_name = 3;
}
message TokenDeltaEvent { string text = 1; }
message ReasoningDeltaEvent { string text = 1; }
message TurnCompletedEvent { string content = 1; string reasoning = 2; ContextSnapshot context = 3; }
message ToolsProposedEvent { repeated ProposedToolCall calls = 1; }
message ProposedToolCall {
  string call_id = 1;
  string name = 2;
  string arguments_json = 3;
  string preview = 4;
}
message ToolExecutionStartedEvent { string call_id = 1; }
message ToolExecutionCompletedEvent { string call_id = 1; string output = 2; }
message ToolExecutionFailedEvent { string call_id = 1; string error = 2; }
message ToolsCompletedEvent {}
message RunCompletedEvent { string run_id = 1; string content = 2; string reasoning = 3; }
message RunCancelledEvent { string run_id = 1; }
message RunFailedEvent { string run_id = 1; string error = 2; }

message ContextSnapshot {
    int32 context_size = 1;
    int32 system_tokens = 2;
    int32 history_tokens = 3;
    int32 memory_tokens = 4;
    int32 total_tokens = 5;
    int32 remaining_tokens = 6;
    int32 history_messages = 7;
    int32 memory_messages = 8;
    int32 total_messages = 9;
    int32 history_budget = 10;
    repeated MessageStats messages = 11;
    int32 tool_tokens = 12;
}

message MessageStats {
    string role = 1;
    int32 tokens = 2;
    string source = 3;
}

